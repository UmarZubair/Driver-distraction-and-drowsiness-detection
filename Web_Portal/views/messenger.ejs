<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Messages</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- favicon ============================================ -->
    <link rel="shortcut icon" type="image/x-icon" href="../img/test.png">

    <!-- Google Fonts ============================================ -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,700,900" rel="stylesheet">
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.0/css/all.css'
        integrity='sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ' crossorigin='anonymous'>
    <!-- Bootstrap CSS
		============================================ -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <!-- Bootstrap CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/font-awesome.min.css">
    <!-- owl.carousel CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/owl.carousel.css">
    <link rel="stylesheet" href="../css/owl.theme.css">
    <link rel="stylesheet" href="../css/owl.transitions.css">
    <!-- meanmenu CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/meanmenu/meanmenu.min.css">
    <!-- animate CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/animate.css">
    <!-- normalize CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/normalize.css">
    <!-- mCustomScrollbar CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/scrollbar/jquery.mCustomScrollbar.min.css">
    <!-- jvectormap CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/jvectormap/jquery-jvectormap-2.0.3.css">
    <!-- notika icon CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/notika-custom-icon.css">
    <!-- wave CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/wave/waves.min.css">
    <!-- main CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/main.css">
    <!-- style CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- responsive CSS
            ============================================ -->
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/messenger.css">
    <!-- modernizr JS
            ============================================ -->
    <script src="../js/vendor/modernizr-2.8.3.min.js"></script>

    <link rel='stylesheet' href='../css/reset.css'>
    <script src="https://use.typekit.net/hoy3lrg.js"></script>
    <script>try { Typekit.load({ async: true }); } catch (e) { }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>

    <style>
        a:hover {
            color: #337ab7;
        }

        /* The Modal (background) */
        .customModal {
            display: none;
            position: fixed;
            z-index: 100;
            padding-top: 200px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            font-family: Helvetica, Arial, sans-serif;
        }

        /* Modal Content */
        .customModal-content {
            font-family: Roboto, Helvetica, Arial, sans-serif;
            position: relative;
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: 1px solid #4267b2;
            width: 40%;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            -webkit-animation-name: animatetop;
            -webkit-animation-duration: 0.4s;
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        @media only screen and (max-width: 600px) {
            .customModal-content {
                width: 90%;
            }
        }

        /* Add Animation */
        @-webkit-keyframes animatetop {
            from {
                top: -300px;
                opacity: 0
            }

            to {
                top: 0;
                opacity: 1
            }
        }

        @keyframes animatetop {
            from {
                top: -300px;
                opacity: 0
            }

            to {
                top: 0;
                opacity: 1
            }
        }

        #confirmRouterDel .customModal-header {
            padding: 10px 16px;
            background-color: #4267b2;
            color: white;
            height: 40px;
        }

        .customModal-body {
            font-size: 16px;
            padding: 15px 16px;
        }

        .customModal-footer {
            padding: 21px 1px;
            text-align: right;
        }

        #confirmRouterDel .modalBtn {
            text-decoration: none;
            background-color: #4267b2;
            color: white;
            padding: 10px 30px;
            border-radius: 4px;
            cursor: pointer;
            border: 0px;
        }

        #confirmRouterDel .modalBtn:hover {
            background-color: #355596;
            box-shadow: 2px 5px 5px #EDF2ED;
        }

        #main-menu>li.active>a,
        #main-menu>li.active>a:focus,
        #main-menu>li.active>a:hover {
            color: #ffffff;
            cursor: pointer;
            background-color: #fc4040;
            border: 1px solid #fc4040;
            border-bottom-color: transparent;
        }

        #close {
            float: right;
            margin-top: -15px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
    <script>
        function create() {
            $('#confirmRouterDel').css('display', 'block');
        }
    </script>
</head>

<body>
    <% include partials/topBar %>
    <!-- Mobile Menu start 
    <div class="mobile-menu-area">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="mobile-menu">
                        <nav id="dropdown">
                            <ul class="mobile-menu-nav">
                                <li><a data-toggle="collapse" data-target="#Charts" href="#">Home</a>
                                    <ul class="collapse dropdown-header-top">
                                        <li><a href="index.html">Dashboard One</a></li>
                                        <li><a href="index-2.html">Dashboard Two</a></li>
                                        <li><a href="index-3.html">Dashboard Three</a></li>
                                        <li><a href="index-4.html">Dashboard Four</a></li>
                                        <li><a href="analytics.html">Analytics</a></li>
                                        <li><a href="widgets.html">Widgets</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
     Mobile Menu end -->

    <!-- Main Menu area start
    <div class="main-menu-area mg-tb-40">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <ul id="main-menu" class="nav nav-tabs notika-menu-wrap menu-it-icon-pro">
                        <li><a href="/dashboard"><i class="fa fa-home"></i> Home</a></li>
                        <li><a data-toggle="tab" href="#drivers"><i class="fa fa-users"></i> Manage Drivers</a></li>
                        <li class="active"><a href="/messenger"><i class="fa fa-envelope"></i> Messages</a></li>
                        <li><a href="/updateProfile"><i class="fa fa-list"></i> Edit Profile</a></li>
                        <li><a href="/logout"><i class="fa fa-sign-out"></i> Log Out</a></li>
                    </ul>
                    <div class="tab-content custom-menu-content">
                        <div id="drivers" class="tab-pane notika-tab-menu-bg animated flipInX">
                            <ul class="notika-main-menu-dropdown">
                                <li><a href="/crud/list-of-drivers"><i class="fa fa-list"></i> List of Drivers</a>
                                </li>
                                <li><a href="/crud/add"><i class="fa fa-user-plus"></i> Add New Driver</a></li>

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    Main Menu area End-->
    <div class="container-fluid" style="padding-left: 0;">
        <div class="row">
            <div class="col-md-2">
                <div id="cssmenu">
                        <img src="../public/img/innerLogo.png" width="160px" style=" margin-left: 60px; margin-top: -130px;" />
                    <ul>
                        <li><a href="/dashboard"><i class="fa fa-fw fa-home"></i> Dashboard</a></li>
                        <li class="has-sub"><a href="#"><i class="fa fa-fw fa-users"></i> Manage Drivers</a>
                            <ul>
                                <li><a href="/crud/add"><i class="fa fa-fw fa-user-plus"></i> Add New Driver</a></li>
                                <li><a href="/crud/list-of-drivers"><i class="fa fa-fw fa-list"></i> List of Drivers</a>
                                </li>
                            </ul>
                        </li>
                        <li class="active"><a href="/messenger"><i class="fa fa-fw fa-commenting"></i> Messenger</a></li>
                        <li><a href="/updateProfile"><i class="fa fa-fw fa-newspaper-o"></i> My Profile</a>
                        </li>
                        <li><a href="/logout"><i class="fa fa-fw fa-sign-out"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-10">
                <!-- Breadcomb area Start-->
                <div class="breadcomb-area">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <div class="breadcomb-list">
                                    <div class="row">
                                        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                            <div class="breadcomb-wp">
                                                <div class="breadcomb-icon">
                                                    <i class="fa fa-envelope"></i>
                                                </div>
                                                <div class="breadcomb-ctn">
                                                    <h2>Messages</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Breadcomb area End-->
                <%  if( !receiverid == "" ){  
      %>
                <p id="IdToSend" style="display: none"><%= receiverid %></p>
                <% } else {%>
                <p id="IdToSend" style="display: none"></p>
                <% } %>
                <div id="frame">
                    <div id="sidepanel">
                        <div id="search">
                            <label for=""><i class="fa fa-search" aria-hidden="true"></i></label>
                            <input type="text" placeholder="Search Driver..." />
                        </div>
                        <div id="contacts">
                            <ul id="msgs-list" class="msgs-list">
                                <!--<li id="newMsg" class="contact">

                    </li>-->
                                <% var i=0 ;
                 messages.forEach(msg => {
                        var fullpath= '../' + msg.driverDP;

                        var lastMsg = (msg.chat[msg.chat.length-1]).message_body;
                %>
                                <li id='<%= msg.driverId %>' class="contact">
                                    <div class="wrap">
                                        <img src="<%= fullpath %>" />
                                        <div class="meta">
                                            <p class="name"><%= msg.driverName %></p>
                                            <p id="preview" class="preview"><%= lastMsg %></p>
                                        </div>
                                    </div>
                                </li>
                                <% }) %>
                            </ul>
                        </div>

                        <div id="bottom-bar">
                            <a href='javascript:void(0)' onClick='create();' id="addcontact"><i class="fa fa-user-plus"
                                    aria-hidden="true"></i> <span>Create New
                                    Conversation</span></a>
                        </div>
                        <!-- The Router Delete Confirmation Modal -->
                        <div id="confirmRouterDel" class="customModal">
                            <!-- Modal content -->
                            <div class="customModal-content">
                                <div class="customModal-header">
                                    <h2>Create New Message</h2><i id="close" class="fa fa-close"
                                        onClick="JavaScript: $('#confirmRouterDel').css('display', 'none');"></i>
                                </div>

                                <div class="customModal-body">
                                    <div class="row">
                                        <div class="col-lg-2 col-md-3 col-sm-3 col-xs-12">
                                            <div class="cmp-int-lb cmp-int-lb1 text-right">
                                                <span>To: </span>
                                            </div>
                                        </div>
                                        <div class="col-lg-10 col-md-9 col-sm-9 col-xs-12">
                                            <div class="form-group">
                                                <div class="nk-int-st cmp-int-in cmp-email-over">
                                                    <input type="text" id='browserinput' name='browserinput'
                                                        list="browsers" class="form-control" autocomplete="off">

                                                    <datalist id="browsers">
                                                        <% drivers.forEach(driver => { %>
                                                        <option id='<%= driver._id%>'
                                                            value='<%= driver.firstName + " " + driver.lastName %>'>
                                                        </option>
                                                        <% }) %>
                                                    </datalist>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-2 col-md-3 col-sm-3 col-xs-12">
                                            <div class="cmp-int-lb cmp-int-lb1 text-right">
                                                <span>Message: </span>
                                            </div>
                                        </div>
                                        <div class="col-lg-10 col-md-9 col-sm-9 col-xs-12">
                                            <div class="form-group">
                                                <div class="nk-int-st cmp-int-in cmp-email-over">
                                                    <textarea id="message" name="message" class="form-control"
                                                        rows="8"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="customModal-footer">
                                        <button class="modalBtn" id="sendBtn">SEND</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="no-content" style="text-align: center;">
                        <img src="../public/images/empty_chat_icon.png" width="20%" style=" margin-top: 220px;" />
                        <h3 style="color: #34495e; font-size: 18px;">Start a new chat with any of your company
                            registered driver!! </h3>
                    </div>

                    <div id="has-content" class="content">
                        <div id="msg-head" class="contact-profile">
                            <%  if( !receiverid == "" ){  %>
                            <img id="receiverPic" src="../<%= dp %>" alt="" />
                            <p id="receiverName"> <%= name %> </p>
                            <% } else {%>
                            <img id="receiverPic" src="" alt="" />
                            <p id="receiverName"></p>
                            <% } %>
                        </div>
                        <div id="msg-content" class="messages">
                            <% messages.forEach(msg => { console.log(msg.driverId); %>

                            <ul id="cht-<%= msg.driverId %>" style="display: none;">
                                <% msg.chat.forEach(chat => { 
                            if(chat.senderId == ManagerID){ %>
                                <li class="replies">
                                    <img src="../public/img/m.png"
                                        alt="" />
                                    <p><%= chat.message_body %>
                                        <span
                                            style="font-size: 11px;"><br><%= chat.message_date.getHours() + ":" + chat.message_date.getMinutes() %></span>
                                    </p>


                                </li>
                                <% } else { %>
                                <li class="sent">
                                    <img src="../<%= chat.senderDP %>" alt="" />
                                    <p><%= chat.message_body %></p>
                                </li>
                                <% } %>
                                <% }) %>
                            </ul>
                            <% }) %>
                        </div>
                        <div class="message-input">
                            <div class="wrap">
                                <input id="message1" type="text" placeholder="Write your message..." />
                                <i class="fa fa-paperclip attachment" aria-hidden="true"></i>
                                <button id="sendMsg" class="submit"><i class="fa fa-paper-plane"
                                        aria-hidden="true"></i></button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script
        src='//production-assets.codepen.io/assets/common/stopExecutionOnTimeout-b2a7b3fe212eaa732349046d8416e00a9dec26eb7fd347590fbced3ab38af52e.js'></script>
    <script src='https://code.jquery.com/jquery-2.2.4.min.js'></script>
    <script>
        var socket = io.connect('http://localhost:3000');
        $(document).ready(function () {

            if (! '<%= receiverid%>' == "") {
                $('#no-content').hide();
                $('#has-content').show();

                $('.msgs-list li').removeClass('active');
                $('#' + '<%= receiverid%>').addClass('active');

                socket.emit('messageArea', {
                    driverID: '<%= receiverid%>'
                });
            } else {
                $('#no-content').show();
                $('#has-content').hide();
            }

            var check = "cht-" + document.getElementById("IdToSend").innerHTML;
            if ('<%= count %>' > 0) {
                $(".spinnerDiv").show();
                $(".badgeDiv").show();
            }
            $("#msg-content ul").map(function () {
                if (this.id === check) {
                    $('#msg-content ul').hide();
                    $('#' + this.id).show();
                }
            })
            $(".messages").animate({ scrollTop: $("#msg-content ul").height() }, "fast");
            
        });
        $(window).on("load", function () {
                $('.has-sub ul').hide();
                $('#cssmenu li.active').addClass('open').children('ul').show();
                $('#cssmenu li.has-sub>a').on('click', function () {
                        $(this).removeAttr('href');
                        var element = $(this).parent('li');
                        if (element.hasClass('open')) {
                                element.removeClass('open');
                                element.find('li').removeClass('open');
                                element.find('ul').slideUp();
                        } else {
                                element.addClass('open');
                                element.children('ul').slideDown();
                                element.siblings('li').children('ul').slideUp();
                                element.siblings('li').removeClass('open');
                                element.siblings('li').find('li').removeClass('open');
                                element.siblings('li').find('ul').slideUp();
                        }
                });

                $(window).scroll(function () {
                        myFunction();
                });
                var navbar = document.getElementById("navbar");
                var copy = document.getElementById("sticky-copy");
                var sticky = navbar.offsetTop;
                function myFunction() {
                        if (window.pageYOffset >= sticky) {
                                navbar.style.position = "";
                                copy.style.display = "block";
                                navbar.classList.add("sticky");

                        }
                }
        });
        

    </script>

    <script src="../chat.js"></script>
    <script src="../bin/www"></script>
    <!-- jquery
		============================================ -->
    <script src="../js/vendor/jquery-1.12.4.min.js"></script>
    <!-- bootstrap JS
            ============================================ -->
    <script src="../js/bootstrap.min.js"></script>
    <!-- wow JS
            ============================================ -->
    <script src="../js/wow.min.js"></script>
    <!-- price-slider JS
            ============================================ -->
    <script src="../js/jquery-price-slider.js"></script>
    <!-- owl.carousel JS
            ============================================ -->
    <script src="../js/owl.carousel.min.js"></script>
    <!-- scrollUp JS
            ============================================ -->
    <script src="../js/jquery.scrollUp.min.js"></script>
    <!-- meanmenu JS
            ============================================ -->
    <script src="../js/meanmenu/jquery.meanmenu.js"></script>
    <!-- counterup JS
            ============================================ -->
    <script src="../js/counterup/jquery.counterup.min.js"></script>
    <script src="../js/counterup/waypoints.min.js"></script>
    <script src="../js/counterup/counterup-active.js"></script>
    <!-- mCustomScrollbar JS
            ============================================ -->
    <script src="../js/scrollbar/jquery.mCustomScrollbar.concat.min.js"></script>
    <!-- jvectormap JS
            ============================================ -->
    <script src="../js/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
    <script src="../js/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <script src="../js/jvectormap/jvectormap-active.js"></script>
    <!-- sparkline JS
            ============================================ -->
    <script src="../js/sparkline/jquery.sparkline.min.js"></script>
    <script src="../js/sparkline/sparkline-active.js"></script>
    <!-- sparkline JS
            ============================================ -->
    <script src="../js/flot/jquery.flot.js"></script>
    <script src="../js/flot/jquery.flot.resize.js"></script>
    <script src="../js/flot/curvedLines.js"></script>
    <script src="../js/flot/flot-active.js"></script>
    <!-- knob JS
            ============================================ -->
    <script src="../js/knob/jquery.knob.js"></script>
    <script src="../js/knob/jquery.appear.js"></script>
    <script src="../js/knob/knob-active.js"></script>
    <!--  wave JS
            ============================================ -->
    <script src="../js/wave/waves.min.js"></script>
    <script src="../js/wave/wave-active.js"></script>
    <!--  todo JS
            ============================================ -->
    <script src="../js/todo/jquery.todo.js"></script>
    <!-- plugins JS
            ============================================ -->
    <script src="../js/plugins.js"></script>
    <!--  Chat JS
            ============================================ -->
    <script src="../js/chat/moment.min.js"></script>
    <script src="../js/chat/jquery.chat.js"></script>
    <!-- main JS
            ============================================ -->
    <script src="../js/main.js"></script>

</body>

</html>